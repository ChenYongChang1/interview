计算机网络
===
参考：
* [前端必备HTTP技能之HTTP请求头响应头中常用字段详解](http://www.jianshu.com/p/6e86903d74f7)
* [《网络是怎样连接的》读书笔记](http://www.shymean.com/article/%E3%80%8A%E7%BD%91%E7%BB%9C%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%9E%E6%8E%A5%E7%9A%84%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0)

## 问题
* url从地址栏输入到展示整个页面发生了什么
* 状态码
* 缓存控制
* Token及JSON Web Token认证原理
* Cookie、Session、LocalStorage和SessionStorage的作用及差异
* https
* HTTP2

## 网络请求流程
此处需要对网络有个大概的认识
* DNS服务器解析域名
* HTTP报文
* TCP连接三次握手、四次挥手
* IP地址
* 广播MAC寻址
* 服务器CGI程序

## TCP建立连接三次握手
TCP连接操作的大致流程如下
* 第一步是在TCP模块创建表示控制信息的头部，
    * 设置发送方和接收方的端口号和SYN比特，通过头部中发送方和接收方的端口号可以找到要连接的套接字
    * 然后客户端的TCP模块委托IP模块发送包含TCP头部的网络包，
* 服务器的TCP模块会根据这个网络包的TCP头部信息找到需要连接的服务器套接字信息，并写入相关信息，修改为正在连接状态然后服务器的TCP模块会返回响应
    * 这个过程与客户端一样，创建控制信息的头部。
    * 此外在返回响应时还需要将ACK控制位设置为1，表示通信确认。
    * 然后服务器的TCP模块委托其IP模块发送响应数据包
* 客户端的TCP模块通过响应数据包的TCP头部信息确认连接服务器的操作是否成功，如果SYN为1则表示成功，此时会向客户端的套接字中写入服务器的IP地址、端口号等信息
* 后，客户端需要将ACK比特设置为1然后发回服务器，告知服务器刚才的响应包已经收到

可以看见，上面一共进行了三次数据包的发送（客户端两次，服务器一次），因此被称为三次握手。

## TCP建立连接四次挥手
在数据收发完成以后，就可以选择断开连接了。完成数据的发送的一方会断开过程，这里以服务器举例：
* 首先，服务器协议栈会生成包含断开信息的TCP头部（即将FIN比特设为1），接着委托IP模块发送，同时，服务器的套接字会记录断开操作的相关信息
* 客户端协议栈收到FIN为1的TCP头部时，会将客户端自己的套接字标记为进入断开的状态，同时向服务器发送一个ACK号表示确认收到服务器的断开操作
* 过了一会应用程序读取了全部的数据之后，客户端协议栈也会与服务器协议栈一样，生成一个包含断开信息FIN为1的包，委托IP模块发送给服务器
* 服务务器最后会返回包含ACK号的确认包，最后会删除对应的套接字

可以看见断开连接一共需要发送4个数据包（服务器两个，客户端两个），因此被称为四次挥手。

## 路由器的中转规则
路由器的端口是以实际的发送方和接收方来收发网络包的，因此路由器的每个端口都具有MAC地址和IP地址，只接受与自身地址匹配的包。

路由器根据IP地址表来判断转发目标，实际上这里的IP地址只包含表示子网的网络号部分的比特值（这里就体现了子网掩码的作用，即表示在匹配网络包目标地址时需要对比的比特数量），而表示主机号部分的比特值全部为0（这与交换机不同，交换机会匹配完整的MAC地址），这样就可以将多条某个子网的IP导向同一个端口。

有时候可能会匹配多条子网记录，此时路由器会寻找网络号比特位最长的（网络号越长，说明主机号越短，子网内可分配的主机越少，可以缩小目标范围），如果网络号比特位相等，则匹配跃点数最小的记录。

有时地址本身的子网掩码和路由表 中的子网掩码是不一致的，这是路由聚合的结果。路由聚合会将几个子 网合并成一个子网，并在路由表中只产生一条记录。经过路由聚合，多个子网会被合并成一个子网，子网掩码会发生 变化，同时，目标地址列也会改成聚合后的地址。

## 服务器响应
一般的做法是每有一个客户端连接进来，就fork一个新的服务器程序
* 服务器程序包含两个模块，等待连接模块和负责与客户端通信的模块
* 服务器启动后完成初始化操作，运行等待模块，创建套接字，等待客户端的连接
* 接收到客户端连接时，等待模块会恢复运行并接收连接，然后启动服务器的客户端通信模块，并移交完成连接的套接字
* 每次有新的客户端发起连接，都会启动一个新的客户端通信模块（这个过程需要消耗服务器性能），因此通信模块与客户端是一对一的关系

## 本地起了一个http server，为什么只能在同一个WIFI(局域网)上访问？
你没有公网IP当然就不能被外网访问了。常见的WIFI情况下，一般的ip会是~192.168.0.x·这样的，只是对局域网(同WIFI下)可见，并没有部署到公开外网，因此外网是访问不了的。


## CDN
CDN网络是在用户和服务器之间增加Cache层，如何将用户的请求引导到Cache上获得源服务器的数据，主要是通过接管DNS实现，当业务需要接入到 CDN 时，用户只需调整自己的 DNS 配置信息，将 A 记录改为 CNAME 记录，将内容改为 CDN 厂商所提供的接入域名即可。

* 由于CDN对域名解析过程进行了调整，所以解析函数库得到的是该域名对应的CNAME记录，
* 为了得到实际的CDN服务器地址，浏览器需要再次对获得的CNAME进行解析，使用全局的负载均衡，分配靠近用户的CDN缓存服务器
* 缓存服务器根据浏览器提供的需要访问的域名，使用内部专用DNS解析得到此域名的实际IP，向该原始服务器请求数据，一方面缓存数据，一方面返回给浏览器，后续访问在缓存失效前可直接返回缓存
* 浏览器不在意数据从何处返回，能以较小延迟返回即可